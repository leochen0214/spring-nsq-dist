[[getting-started]]
== Getting started

* 添加 `spring-nsq` maven依赖

推荐使用spring-nsq提供的bom管理版本依赖

[source,xml,indent=0,subs="verbatim,quotes,attributes"]
----
<properties>
    <spring-nsq-dependencies.version>{spring-nsq-version}</spring-nsq-dependencies.version>
</properties>

<dependencies>
    <dependency>
        <groupId>com.youzan.spring.nsq</groupId>
        <artifactId>spring-nsq</artifactId>
    </dependency>
</dependencies>

<dependencyManagement>
    <dependencies>
	    <dependency>
	        <!-- Import dependency management from spring-nsq -->
	        <groupId>com.youzan.spring.nsq</groupId>
            <artifactId>spring-nsq-dependencies</artifactId>
	        <version>${spring-nsq-dependencies.version}</version>
	        <type>pom</type>
		    <scope>import</scope>
	    </dependency>
    </dependencies>
</dependencyManagement>
----

=== Non spring-boot application
** Java Configuration

[source,java,indent=0]
----
include::{code-examples}/AppConfig.java[tag=configuration]
----

=== spring-boot application

* 引入如下pom即可，无需如上显示配置

[source,xml,indent=0,subs="verbatim,quotes,attributes"]
----
<dependency>
    <groupId>com.youzan.spring.nsq</groupId>
    <artifactId>nsq-spring-boot-starter</artifactId>
</dependency>
----

* application.properties
[source,properties,indent=0,subs="verbatim,attributes,macros"]
----
spring.nsq.lookup-address=sqs-qa.s.qima-inc.com:4161
----

=== 应用使用

==== 消费消息(业务Listener)

[source,java,indent=0]
----
@Component
public class Listener {

  @NsqListener(topics = "JavaTesting-Ext", channel = "default")
  public void listener2(Person person) {
    logger.info("listener2 person={}", person);
  }

}

include::{code-examples}/Person.java[tag=configuration]
----


==== 发送消息

[source,java,indent=0]
----
@Component
public class MessageSender{

     @Resource
     private NsqTemplate nsqTemplate;

     public void send() {
        Person p = new Person();
        p.setName("jack");
        p.setAge(18);
        p.setSex("male");
        nsqTemplate.send("JavaTesting-Ext", p1);
     }
}
----

== More Feature

=== Consumer Feature
消费者消息处理器支持多种类型方法参数。`@NsqListener` 中的属性支持spring ${…​} placeholders, 还支持SpEL表达式({springframework-docs}/core.html#expressions)

==== support json string

[source,java,indent=0]
----
   @NsqListener(topics = "JavaTesting-Ext", channel = "default")
   public void listener1(String json) {
     logger.info("listener1 personJson={}", json);
   }
----

==== support plain POJO object

[source,java,indent=0]
----
  @NsqListener(topics = "${topic}", channel = "default", errorHandler ="personListenerErrorHandler")
  public void listener2(Person person) {
    logger.info("listener2 person={}", person);
  }
----

==== support origin NSQMessage object

[source,java,indent=0]
----
  @NsqListener(topics = "JavaTesting-Ext", channel = "default")
  public void listener4(NSQMessage message) {
    logger.info("listener4 message content={}, , headers={}", message.getReadableContent(), message.getJsonExtHeader());
  }
----
==== support origin NSQMessage and Consumer object

[source,java,indent=0]
----
  @NsqListener(topics = "JavaTesting-Ext", channel = "default")
  public void listener5(NSQMessage message, Consumer consumer) {
    logger.info("listener5 message content={}, , headers={}", message.getReadableContent(), message.getJsonExtHeader());
  }
----

==== support Spring-Messaging Message object

[source,java,indent=0]
----
  @NsqListener(topics = "JavaTesting-Ext", channel = "default")
  public void listener6(Message<Person> message) {
    logger.info("listener6 person={}, headers=", message.getPayload(), message.getHeaders());
  }
----

==== support Spring-Messaging annotation

[source,java,indent=0]
----
  @NsqListener(topics = "JavaTesting-Ext", channel = "default")
  public void listener7(@Payload Person person) {
    logger.info("listener7, message paylod={}", person);
  }

  @NsqListener(topics = "JavaTesting-Ext", channel = "default")
  public void listener8(@Payload Person message, @Headers MessageHeaders headers) {
    logger.info("listener8, message paylod={}, headers={}", message, headers);
  }

  @NsqListener(topics = "${topic}", channel = "default")
  public void listener9(@Payload Person message, @Headers Map<String, Object> headers) {
    System.out.println("listener9, message paylod=" + message + ", headers=" + headers);
  }
----

==== 支持消息重新投递策略

* 应用实现 `com.youzan.spring.nsq.core.RequeuePolicy` 接口

[source,java,indent=0]
----
/**
 * 消息重试策略
 * 前3次失败，每5s后重试
 * 第4-6次失败，每1min后重试
 * 第7-9次失败，每10min后重试
 * 超过9次，每小时重试
 */
@Component
@Slf4j
public class SomeRequeuePolicy implements RequeuePolicy {

  @Override
  public void requeue(NSQMessage nsqMessage) {

    int nextConsuming = 5;
    if (nsqMessage.getReadableAttempts() < 3 ){
      nextConsuming = 5;
    }else if (nsqMessage.getReadableAttempts() >=3 && nsqMessage.getReadableAttempts() < 6){
      nextConsuming = 60;
    }else if (nsqMessage.getReadableAttempts() >= 6 && nsqMessage.getReadableAttempts() < 9){
      nextConsuming = 600;
    }else {
      nextConsuming = NSQConfig._MAX_NEXT_CONSUMING_IN_SECOND;
    }

    try {
      nsqMessage.setNextConsumingInSecond(nextConsuming);
      LogUtils.warn(log, "[消息处理]-重试策略，发起第{}次重试, message={}", nsqMessage.getReadableAttempts() + 1, nsqMessage);
    } catch (Exception e) {
      LogUtils.error(e, log, "[消息处理]-重试策略，重试异常");
    }

  }
}
----

* 指定 @NsqListener requeuePolicy spring bean name

[source,java,indent=0]
----
  @NsqListener(topics = "JavaTesting-Ext", channel = "default", requeuePolicy="someRequeuePolicy")
  public void listener7(@Payload Person person) {
    logger.info("listener7, message paylod={}", person);
  }
----

==== 支持解析dts消息

dts发送的消息，会在原有POJO对象上包装一层, headers 和 bizBody， 消息Listener可以指定 `unpackMessage=true`, 这样就可以提取出原有POJO对象

[source,java,indent=0]
----
   @NsqListener(topics = "${nsq.topic.assetcenter.pay}", channel = "${nsq.channel.assetcenter.pay}", unpackMessage = true)
   public void onPaymentSuccess(UniformPayEvent uniformPayEvent) {
     if (uniformPayEvent == null) {
       return;
     }

     if (!isPaySuccess(uniformPayEvent.getStatus())) {
       return;
     }

     String tradeNo = getTradeNo(uniformPayEvent);
     if (StringUtils.isBlank(tradeNo)) {
       return;
     }

     doProcessAndSend(uniformPayEvent, tradeNo);
   }
----


=== Producer

消息发送，提供了Spring Template一贯风格的接口

[source,java,indent=0]
----
public interface NsqOperations {


  /**
   * send with payload data
   *
   * @param topic the topic name
   * @param data  the payload data
   * @param <T>   the payload type
   * @throws NsqMessagePublishFailedException throws exception when message send failed
   */
  <T> void send(String topic, T data) throws NsqMessagePublishFailedException;

  /**
   * send with nsq client origin Message
   */
  void send(Message nsqMessage) throws NsqMessagePublishFailedException;

  /**
   * send with Spring-Messaging message
   *
   * @param topic         the topic name
   * @param springMessage the Spring-Messaging message
   */
  void send(String topic, org.springframework.messaging.Message<?> springMessage)
      throws NsqMessagePublishFailedException;


  /**
   * send with ProducerCallback
   *
   * @param callback the ProducerCallback
   * @throws NsqMessagePublishFailedException throws exception when message send failed
   */
  void execute(ProducerCallback callback) throws NSQException;


  interface ProducerCallback {

    void doExecute(Producer producer) throws NSQException;
  }

}
----

== tracing

=== 使用

==== 添加如下依赖

[source,xml,indent=0,subs="verbatim,quotes,attributes"]
----
<dependency>
    <groupId>com.youzan.spring.nsq</groupId>
    <artifactId>nsq-tracing-spring-boot-starter</artifactId>
</dependency>
----

==== 应用日志会输出traceId, spanId

* consumer-1(topic: JavaTesting-Ext , channel: default)

[indent=0]
----
$ 2018-09-09 00:32:33.804  INFO [nsq-tracing-consumer-1,24ff9cf273b8227d,dd839f3e3abd5e3e,false] 21763 --- [t-Pool-Thread-1] com.example.nsqtracingconsumer1.Listener1  : listener1 person=name=jack, age=18, sex=male
----

* consumer-2(topic: JavaTesting-Ext , channel: test)

[indent=0]
----
$ 2018-09-09 00:32:33.804  INFO [nsq-tracing-consumer-2,24ff9cf273b8227d,5e1e389392b12a75,false] 21716 --- [t-Pool-Thread-1] com.example.nsqtracingconsumer2.Listener2  : listener2 payload=name=jack, age=18, sex=male, headers={X-B3-Sampled=0, X-B3-TraceId=24ff9cf273b8227d, id=64d9bdb1-176a-769b-c26d-2d8bdc10d736, X-B3-SpanId=24ff9cf273b8227d, partitionId=0, timestamp=1536424353754}
----

=== 实现原理

消息发送前设置trace header给Producer， 消息接收者提取出trace header，不同channel的消费者享有同一个
traceId, 不同的spanId

[source,properties,indent=0,subs="verbatim,attributes,macros"]
----
   Producer Tracer                                    Consumer Tracer
\+------------------+                               \+------------------+
| \+--------------+ |     \+-----------------+       | \+--------------+ |
| | TraceContext |======>| Message Headers |========>| TraceContext | |
| \+--------------+ |     \+-----------------+       | \+--------------+ |
\+--------||--------+                               \+--------||--------+
   start ||                                                 ||
         \/                                          finish ||
span(context).annotate("ms")                                \/
             .address("ma", broker)          span(context).annotate("mr")
                                                          .address("ma", broker)
----

more detail: https://github.com/openzipkin/openzipkin.github.io/blob/master/pages/instrumenting.md#message-tracing


== Architecture

image::spring-nsq-architecture.png[]


